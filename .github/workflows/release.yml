name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install pytest pyinstaller customtkinter pillow pyautogui pyinstaller-hooks-contrib

      - name: Run tests
        shell: pwsh
        run: pytest

      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup --no-progress -y

      - name: Build application
        shell: pwsh
        run: |
          pyinstaller main.spec
          New-Item -ItemType Directory -Path dist/main/img -Force | Out-Null
          New-Item -ItemType Directory -Path dist/main/locales -Force | Out-Null
          New-Item -ItemType Directory -Path dist/main/icons -Force | Out-Null
          Copy-Item -Path img\* -Destination dist/main/img/ -Recurse -Force
          Copy-Item -Path locales\* -Destination dist/main/locales/ -Recurse -Force
          Copy-Item -Path icons\* -Destination dist/main/icons/ -Recurse -Force
          Copy-Item -Path README.pdf -Destination dist/main/ -Force
          python write_mkinstiss.py
          & "C:\\Program Files (x86)\\Inno Setup 6\\ISCC.exe" mkinst.iss

      - name: Create archives
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path release -Force | Out-Null
          $ver = "${{ github.ref_name }}"
          $ver = $ver.TrimStart("v")  # v1.0.4 â†’ 1.0.4
          Compress-Archive -Path dist/main/* -DestinationPath "release/ForTeraterm_${ver}.zip" -Force

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ForTeraterm-${{ github.ref_name }}
          path: |
            release/ForTeraterm_${{ github.ref_name }}.zip
            Output/SetupForTeraterm_${{ github.ref_name }}.exe

      - name: Publish release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/ForTeraterm-${{ github.ref_name }}.zip
            Output/SetupForTeraterm.exe
          body: |
            ## Changes
            ${{ github.event.release.body }}
            ### Commits
            ${{ steps.changelog.outputs.log }}

      - name: Generate changelog text
        id: changelog
        run: |
          LOG=$(git log $(git describe --tags --abbrev=0 --tags ^${GITHUB_REF_NAME})..${GITHUB_REF_NAME} --pretty=format:"- %s")
          echo "log=$LOG" >> $GITHUB_OUTPUT
