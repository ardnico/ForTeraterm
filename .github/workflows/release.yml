name: Build and Release

on:
  push:
    tags:
      - 'v*'     # ä¾‹: v1.0.4
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install pytest pyinstaller customtkinter pillow pyautogui pyinstaller-hooks-contrib

      - name: Run tests
        shell: pwsh
        run: pytest

      - name: Install Inno Setup
        shell: pwsh
        run: choco install innosetup --no-progress -y

      - name: Build application
        shell: pwsh
        run: |
          pyinstaller main.spec
          New-Item -ItemType Directory -Path dist/main/img -Force | Out-Null
          New-Item -ItemType Directory -Path dist/main/locales -Force | Out-Null
          New-Item -ItemType Directory -Path dist/main/icons -Force | Out-Null
          Copy-Item -Path img\* -Destination dist/main/img/ -Recurse -Force
          Copy-Item -Path locales\* -Destination dist/main/locales/ -Recurse -Force
          Copy-Item -Path icons\* -Destination dist/main/icons/ -Recurse -Force
          Copy-Item -Path README.pdf -Destination dist/main/ -Force

          # InnoSetup ISSç”Ÿæˆ
          python write_mkinstiss.py

          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ç”Ÿæˆ
          & "C:\\Program Files (x86)\\Inno Setup 6\\ISCC.exe" mkinst.iss

      - name: Create archives
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path release -Force | Out-Null
          $tag = "${{ github.ref_name }}"         # v1.0.4
          $ver = $tag.TrimStart("v")              # 1.0.4
          Compress-Archive -Path dist/main/* -DestinationPath "release/ForTeraterm-$ver.zip" -Force

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ForTeraterm-${{ github.ref_name }}
          path: |
            release/ForTeraterm-${{ github.ref_name }}.zip
            Output/SetupForTeraterm_${{ github.ref_name }}.exe

      - name: Generate changelog text
        id: changelog
        shell: pwsh
        continue-on-error: true
        run: |
          git fetch --tags

          $current = "${{ github.ref_name }}"
          Write-Host "Current tag: $current"

          # vä»˜ãã‚¿ã‚°ã ã‘ã‚’å¯¾è±¡ã«ã—ã€ç¾åœ¨ã®ã‚¿ã‚°ã‚’é™¤å¤–ã—ãŸä¸Šã§æœ€æ–°1ä»¶ã®ã¿å–å¾—
          $previous = git tag --sort=-creatordate |
            Where-Object { $_ -like "v*" -and $_ -ne $current } |
            Select-Object -First 1

          if (-not $previous) {
            Write-Host "No previous tag found. Using full log."
            $log = git log --pretty=format:"- %s"
          }
          else {
            Write-Host "Previous tag = $previous"
            $log = git log "$previous..$current" --pretty=format:"- %s"
          }

          echo "log=$log" >> $env:GITHUB_OUTPUT

      - name: Publish release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/ForTeraterm-${{ github.ref_name }}.zip
            Output/SetupForTeraterm_${{ github.ref_name }}.exe
          body: |
            ## ðŸ“Œ Changes
            ${{ steps.changelog.outputs.log || 'Changelog could not be generated.' }}

